rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is shop owner
    function isShopOwner(shopId) {
      return request.auth != null 
        && request.auth.uid == get(/databases/$(database)/documents/shops/$(shopId)).data.ownerUid;
    }
    
    // ========================================
    // USERS (for admin panel)
    // ========================================
    match /users/{userId} {
      // Users can read their own data
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Users can create/update their own profile
      allow create, update: if request.auth != null && request.auth.uid == userId;
      
      // Only admins can delete users (handled via Cloud Functions)
      allow delete: if false;
    }
    
    // ========================================
    // SHOPS
    // ========================================
    match /shops/{shopId} {
      // Public shop info (name, slug, services list) - needed for booking page
      allow read: if true;
      
      // Only the shop owner can update their shop
      allow update: if request.auth != null && request.auth.uid == resource.data.ownerUid;
      
      // Any authenticated user can create a shop (registration)
      allow create: if request.auth != null && request.auth.uid == request.resource.data.ownerUid;
      
      // Only the shop owner can delete their shop
      allow delete: if request.auth != null && request.auth.uid == resource.data.ownerUid;
      
      // ========================================
      // SERVICES (public - needed for booking)
      // ========================================
      match /services/{serviceId} {
        allow read: if true;
        allow create, update, delete: if isShopOwner(shopId);
      }
      
      // ========================================
      // STAFF (public - needed for booking)
      // ========================================
      match /staff/{staffId} {
        allow read: if true;
        allow create, update, delete: if isShopOwner(shopId);
      }
      
      // ========================================
      // AVAILABILITY (public - needed for booking)
      // ========================================
      match /availability/{slotId} {
        allow read: if true;
        
        // Owner can manage slots
        allow create, delete: if isShopOwner(shopId);
        
        // Owner can update anything; booking flow can mark slot unavailable
        allow update: if isShopOwner(shopId)
          || (request.resource.data.available == false && resource.data.available == true);
      }
      
      // ========================================
      // BOOKINGS (restricted - contains PII)
      // ========================================
      match /bookings/{bookingId} {
        // Only shop owner can read all bookings
        // Clients can read their own booking by refCode (handled via query)
        allow read: if isShopOwner(shopId)
          || (resource.data.clientEmail == request.auth.token.email)
          || (resource.data.refCode != null);
        
        // Anyone can create a booking (clients booking appointments)
        allow create: if true;
        
        // Only the shop owner can update or delete bookings
        allow update, delete: if isShopOwner(shopId);
      }
      
      // ========================================
      // WAITLIST (restricted - contains PII)
      // ========================================
      match /waitlist/{entryId} {
        // Only shop owner can read waitlist
        allow read: if isShopOwner(shopId)
          || (resource.data.refCode != null);
        
        // Anyone can join the waitlist
        allow create: if true;
        
        // Only the shop owner can manage waitlist
        allow update, delete: if isShopOwner(shopId);
      }
      
      // ========================================
      // WALK-INS (restricted - contains PII)
      // ========================================
      match /walkins/{walkinId} {
        // Only shop owner can read walk-ins
        allow read: if isShopOwner(shopId);
        
        // Anyone can check in as a walk-in
        allow create: if true;
        
        // Only the shop owner can manage walk-ins
        allow update, delete: if isShopOwner(shopId);
      }
      
      // ========================================
      // CLIENT NOTES (private - owner only)
      // ========================================
      match /clientNotes/{noteId} {
        allow read, write: if isShopOwner(shopId);
      }
      
      // ========================================
      // SCHEDULE PRESETS (private - owner only)
      // ========================================
      match /schedulePresets/{presetId} {
        allow read, write: if isShopOwner(shopId);
      }
    }
    
    // ========================================
    // DEFAULT DENY
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
